# topmark:header:start
#
#   project      : TopMark
#   file         : tox.ini
#   file_relpath : tox.ini
#   license      : MIT
#   copyright    : (c) 2025 Olivier Biot
#
# topmark:header:end

[tox]
min_version = 4.0
env_list =
    py310, py311, py312, py313, py314,
    py310-typecheck, py311-typecheck, py312-typecheck, py313-typecheck, py314-typecheck,
    # py310-api, py311-api, py312-api, py313-api, py314-api,
    # property-test, # Do not run this environment by default
    lint, format-check, docs, links

isolated_build = true            # respects PEP 517/518 if you use them
skip_missing_interpreters = false

[testenv]
package = skip # Do not build packages in test environments
usedevelop = true                # Use the source tree directly, no egg-link
deps = -r requirements-dev.txt   # pytest, mypy â€¦ already in there
setenv =
    # mbake requires explicit file paths; we use git to list tracked Makefiles robustly (NUL-delimited for xargs -0)
    TOPMARK_MBAKE_FILES_CMD = git ls-files -z -- 'Makefile' '**/Makefile' 'makefile' '**/makefile'
    # Shared Markdown file list for mdformat (tracked files only)
    TOPMARK_MDFILES_CMD = git ls-files '*.md'
    # Shared lychee invocation (flags centralized for links envs)
    TOPMARK_LYCHEE_CMD = lychee --config lychee.toml --no-progress --verbose
    # Shared lychee pipeline for scanning docstring links under src/
    TOPMARK_LYCHEE_SRC_CMD = find src -type f -name '*.py' -print0 | xargs -0 -r $TOPMARK_LYCHEE_CMD
commands =
    pytest -q tests -m "not slow and not hypothesis_slow"

# --- Hypothesis property test env (Developer only) ---
[testenv:property-test]
description = Run the long-running property tests only
# Inherit everything from the default environment
commands =
    # ONLY run the specific file, without any exclusion marker
    pytest -vv tests/pipeline/test_header_bounds_property.py
labels = local-only

# --- per-Python Pyright envs ---
[testenv:py310-typecheck]
description = Run pyright type checks on Python 3.10
basepython = python3.10
commands = pyright --pythonversion 3.10

[testenv:py311-typecheck]
description = Run pyright type checks on Python 3.11
basepython = python3.11
commands = pyright --pythonversion 3.11

[testenv:py312-typecheck]
description = Run pyright type checks on Python 3.12
basepython = python3.12
commands = pyright --pythonversion 3.12

[testenv:py313-typecheck]
description = Run pyright type checks on Python 3.13
basepython = python3.13
commands = pyright --pythonversion 3.13

[testenv:py314-typecheck]
description = Run pyright type checks on Python 3.14
basepython = python3.14
commands = pyright --pythonversion 3.14

[testenv:quality]
description = Shared settings for lint/format quality envs
# Inherit deps from [testenv] (requirements-dev.txt)
allowlist_externals =
    sh
    git
    xargs

# ---------- Utility envs ----------
[testenv:lint]
description = Run static linters (ruff + pydoclint)
allowlist_externals = {[testenv:quality]allowlist_externals}
commands =
    ruff check .
    pydoclint -q src/topmark tests tools
    # Use shared Makefile file list command for mbake validate
    sh -c "$TOPMARK_MBAKE_FILES_CMD | xargs -0 -r mbake validate --config .bake.toml"

[testenv:lint-fixall]
description = Run ruff with --fix
commands =
    ruff check --fix .
labels = local-only

[testenv:format-check]
description = Check formatting for code, markdown and toml
allowlist_externals = {[testenv:quality]allowlist_externals}
commands =
    ruff format --check .
    sh -c "$TOPMARK_MDFILES_CMD | xargs -r mdformat --check"
    taplo format --check .
    # Use shared Makefile file list command for mbake format check
    sh -c "$TOPMARK_MBAKE_FILES_CMD | xargs -0 -r mbake format --check --config .bake.toml"

[testenv:format]
description = Format code, markdown, and toml (auto-fix)
allowlist_externals = {[testenv:quality]allowlist_externals}
commands =
    ruff format .
    sh -c "$TOPMARK_MDFILES_CMD | xargs -r mdformat"
    taplo format .
    # Use shared Makefile file list command for mbake format
    sh -c "$TOPMARK_MBAKE_FILES_CMD | xargs -0 -r mbake format --config .bake.toml"
labels = local-only

[testenv:docs-base]
description = Shared settings for MkDocs envs
deps = -r requirements-docs.txt

[testenv:docs]
description = Build documentation in strict mode
deps = {[testenv:docs-base]deps}
commands = mkdocs build --strict

[testenv:docs-serve]
description = Serve the docs locally (dev only)
deps = {[testenv:docs-base]deps}
commands = mkdocs serve
labels = local-only

[testenv:links]
description = Check links in docs/ and *.md via lychee (requires CLI lychee)
passenv = *
allowlist_externals = sh
commands =
    sh -c "$TOPMARK_LYCHEE_CMD docs *.md"

[testenv:links-src]
description = Check links found in Python docstrings under src/ via lychee
passenv = *
allowlist_externals = sh
commands =
    sh -c "$TOPMARK_LYCHEE_SRC_CMD"
labels = local-only

[testenv:links-all]
description = Check links in docs/, *.md, and Python docstrings via lychee
passenv = *
allowlist_externals = sh
commands =
    sh -c "$TOPMARK_LYCHEE_SRC_CMD"
    sh -c "$TOPMARK_LYCHEE_CMD docs *.md"
labels = local-only

[testenv:docstring-links]
description = Enforce docstring link style
commands = python tools/check_docstring_links.py --stats
labels = local-only


[testenv:api-snapshot]
description = Shared settings for API snapshot checks
deps = -r requirements-dev.txt
commands = pytest -vv tests/api/test_public_api_snapshot.py
labels = api-check

# --- API snapshot check per Python version ---
[testenv:py310-api]
description = Run only the API snapshot test on Python 3.10
basepython = python3.10
deps = {[testenv:api-snapshot]deps}
commands = {[testenv:api-snapshot]commands}
labels = {[testenv:api-snapshot]labels}

[testenv:py311-api]
description = Run only the API snapshot test on Python 3.11
basepython = python3.11
deps = {[testenv:api-snapshot]deps}
commands = {[testenv:api-snapshot]commands}
labels = {[testenv:api-snapshot]labels}

[testenv:py312-api]
description = Run only the API snapshot test on Python 3.12
basepython = python3.12
deps = {[testenv:api-snapshot]deps}
commands = {[testenv:api-snapshot]commands}
labels = {[testenv:api-snapshot]labels}

[testenv:py313-api]
description = Run only the API snapshot test on Python 3.13
basepython = python3.13
deps = {[testenv:api-snapshot]deps}
commands = {[testenv:api-snapshot]commands}
labels = {[testenv:api-snapshot]labels}

[testenv:py314-api]
description = Run only the API snapshot test on Python 3.14
basepython = python3.14
deps = {[testenv:api-snapshot]deps}
commands = {[testenv:api-snapshot]commands}
labels = {[testenv:api-snapshot]labels}
