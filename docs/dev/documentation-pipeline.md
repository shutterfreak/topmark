<!--
topmark:header:start

  project      : TopMark
  file         : documentation-pipeline.md
  file_relpath : docs/dev/documentation-pipeline.md
  license      : MIT
  copyright    : (c) 2025 Olivier Biot

topmark:header:end
-->

# Documentation Pipeline & Reference Hygiene

This page documents how **TopMark’s documentation is generated, validated, and kept consistent**
using the helpers in `tools/docs/`.

It is intended for contributors working on:

- API documentation
- Internal architecture docs
- Docstring quality and reference hygiene
- MkDocs / mkdocs-gen-files integration

______________________________________________________________________

## Overview

TopMark’s documentation build consists of **three coordinated layers**:

1. **Hand-written Markdown**
   - Located under `docs/`
   - Includes DEV documentation, guides, and architecture notes
1. **Generated Markdown**
   - Produced at build time by `mkdocs-gen-files`
   - Includes API internals, public API reference pages, and CLI reference output
1. **Build-time validation & hygiene**
   - Enforced via MkDocs hooks and shared helpers
   - Ensures symbol references are linkable, consistent, and future-proof

All tooling lives under:

```text
tools/docs/
```

and is **only executed during documentation builds**.

______________________________________________________________________

## Directory Structure

```text
tools/docs/
├── __init__.py
├── hooks.py           # MkDocs simple-hooks
├── gen_api_pages.py   # mkdocs-gen-files script
└── docs_utils.py      # Shared helpers (reference hygiene, logging, paths)
```

This separation is intentional:

- `hooks.py` operates on **Markdown pages**
- `gen_api_pages.py` operates on **Python source modules**
- `docs_utils.py` contains **pure, reusable logic** shared by both

______________________________________________________________________

## Generated Documentation

### Internals pages

Generated by `gen_api_pages.py` under:

```text
api/internals/
```

Characteristics:

- One page per importable module under `src/topmark/`
- Breadcrumb navigation reflecting the package hierarchy
- Per-package `index.md` pages listing immediate children
- A grouped index under `api/internals/topmark/index.md`

Exact public surfaces (defined in `PUBLIC_API_PREFIXES`) are **not generated as internals pages**,
because generating both a public reference page and an internals page for the same module
would create duplicate `mkdocs-autorefs` anchors.

### Public reference pages

Generated under:

```text
api/reference/
```

For modules listed in:

```python
PUBLIC_API_PREFIXES = (
    "topmark.api",
    "topmark.registry",
)
```

These pages represent **stable, supported public surfaces**.

### CLI reference pages

Generated from live TopMark output:

```text
usage/generated-filetypes.md
usage/generated-processors.md
```

via:

```bash
python -m topmark … --output-format markdown
```

This guarantees version-accurate CLI documentation.

______________________________________________________________________

## Docstring Scanning & Reference Hygiene

Both handwritten Markdown **and Python module docstrings** are scanned for
**unlinked backticked symbol references**, such as:

```markdown
`topmark.registry.Registry`
```

Docstring scanning is performed on raw Python source files before `mkdocstrings` renders them into Markdown,
which ensures reported line numbers always refer to the original `src/...` files..

The shared enforcement logic lives in:

```python
tools/docs/docs_utils.py
```

and is used identically by:

- `hooks.py` (Markdown scanning)
- `gen_api_pages.py` (docstring scanning)

### Why this matters

- mkdocs-autorefs can only resolve symbols that are **properly linked**
- Backticked-but-unlinked symbols silently break cross-references
- Docstrings are part of the rendered documentation and must obey the same rules

### What is considered a symbol

A candidate is enforced when it:

- Looks like a dotted Python path
- Starts with `topmark.`
- Is **not** a filename (`.toml`, `.yaml`, …)
- Is **not** explicitly whitelisted

This logic lives in:

```python
tools/docs/docs_utils.should_enforce_link()
```

______________________________________________________________________

## Whitelisting Non-linkable Symbols

Some backticked identifiers are intentional and should **not** be linked.

These are allowed via an **exact-match whitelist**:

```bash
export TOPMARK_DOCS_NONLINKED_SYMBOLS="topmark.toml,topmark.internal_thing"
```

Rules:

- Exact matches only (no prefixes)
- Applies to Markdown *and* docstrings
- Logged in debug mode for transparency

______________________________________________________________________

## Logging, Debug & Strict Modes

Two environment variables control behavior:

### `TOPMARK_DOCS_DEBUG`

When enabled:

- Emits detailed DEBUG/INFO logs
- Shows:
  - Rendered-on context
  - Edit URLs (for Markdown)
  - Alternate inline-link suggestions (`Alt:`)
  - Full symbol lists (no truncation)

### `TOPMARK_DOCS_STRICT_REFS`

When enabled:

- The build **fails** if any unlinked symbols are found
- Failure is aggregated and reported **after** processing all pages
- Uses `mkdocs.exceptions.Abort` for clean termination

Severity parity is enforced between:

- `hooks.py` (Markdown scanning)
- `gen_api_pages.py` (docstring scanning)

______________________________________________________________________

## Contextual Logging

All diagnostics aim to be **actionable**.

Depending on origin, logs include:

- Local repo paths (`docs/...` or `src/...`)
- Line numbers
- Rendered-on pages
- Edit URLs (when available)

Context lines are built centrally via:

```python
tools/docs/docs_utils.context_lines()
```

______________________________________________________________________

## Drafts and Snippets

### Draft files

Files under:

```text
docs/_drafts/
docs/**/_drafts/
```

are:

- Ignored by MkDocs navigation
- Ignored by version control
- Safe for work-in-progress documentation
- visible when serving documentation locally (marked as DRAFT)

### Markdown snippets

Files under:

```text
docs/_snippets/
```

are:

- Intended for inclusion via plugins (e.g. include-markdown)
- **Not** standalone pages
- Explicitly excluded via `exclude_docs` in `mkdocs.yml`

______________________________________________________________________

## Design Principles

The documentation tooling follows a few strict principles:

- **Deterministic**
  No hidden state, no reliance on import order

- **Fail-late, report-all**
  Especially in strict mode

- **Shared logic, single source of truth**
  No duplicated regexes or heuristics

- **Docs are code**
  Docstrings and Markdown are held to the same standard

______________________________________________________________________

## Summary

- Documentation is generated, validated, and enforced as part of the build
- `tools/docs/` is the single authoritative location for documentation tooling
- Reference hygiene is enforced consistently across Markdown and docstrings
- Debug and strict modes provide both flexibility and CI-grade guarantees

If you change how TopMark is structured, **update the docs pipeline accordingly** —
it is a first-class part of the project.
